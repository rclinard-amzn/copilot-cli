# The manifest for the "{{.Name}}" service.
# Read the full specification for the "{{.Type}}" type at:
#  https://aws.github.io/copilot-cli/docs/manifest/lb-web-service/

# Your service name will be used in naming your resources like log groups, ECS services, etc.
name: {{.Name}}
type: {{.Type}}

# Distribute traffic to your service.
http: {{- marshalRRCMinusPathAndDefaultHealthcheck .RoutingRule}}
{{- with .RoutingRule.Path}}
  # Requests to this path will be forwarded to your service.
  # To match all requests you can use the "/" path.
  path: {{quoteStrP .}}
{{- end}}
{{- if .RoutingRule.HealthCheck.IsDefault}}
  # You can specify a custom health check path. The default is "/".
  # healthcheck: '{{.RoutingRule.HealthCheck.HealthCheckPath}}'
{{- end}}

# Configuration for your containers and service.
image:
{{- if .ImageConfig.Image.Location}}
  location: {{.ImageConfig.Image.Location}}
{{- else}}
  # Docker build arguments. For additional overrides: https://aws.github.io/copilot-cli/docs/manifest/lb-web-service/#image-build
  build: {{- marshalYAMLField 2 .ImageConfig.Image.Build}}
{{- end}}
{{- with .ImageConfig.Image.Credentials}}
  credentials: {{quoteStrP .}}
{{- end}}
{{- with .ImageConfig.Image.DockerLabels}}
  labels: {{- marshalYAMLField 2 .ImageConfig.Image.DockerLabels}}
{{- end}}
{{- with .ImageConfig.Image.DependsOn}}
  depends_on: {{- marshalYAMLField 2 .ImageConfig.Image.DependsOn}}
{{- end}}
  # Port exposed through your container to route traffic to it.
  port: {{.ImageConfig.Port}}
{{- if not .ImageConfig.HealthCheck.IsEmpty}}
  # Container health checks: https://aws.github.io/copilot-cli/docs/manifest/backend-service/#image-healthcheck
  healthcheck: {{- marshalYAMLField 2 .ImageConfig.HealthCheck}}
{{- end}}

{{include "task-config" .TaskConfig}}

{{remainder . | marshalYAMLDocument}}
# You can override any of the values defined above by environment.
{{- if .Environments}}
environments: {{- marshalYAMLField 0 .Environments}}
{{- else}}
#environments:
#  test:
#    count: 2               # Number of tasks to run for the "test" environment.
#    deployment:            # The deployment strategy for the "test" environment.
#       rolling: 'recreate' # Stops existing tasks before new ones are started for faster deployments.
{{- end}}
